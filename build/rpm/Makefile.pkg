#
# $Id$
#
include ../../Makefile.inc
include ../../VERSION
include pkginfo.mk

pkg_version = ${version}-${package_build}
pkgsrc_name = ${name}-${version}
specfile = ${pkgsrc_name}.spec
arch =  $(shell uname -i)
pkg_file = ${name}-${pkg_version}.${arch}.rpm

default: build

build: ../../Makefile
	cd ../..; ${MAKE}

../../Makefile: ../../Makefile.in
	cd ../..; ./configure.sh

${specfile}: pkginfo.mk Makefile
	@(echo "Summary : ${Summary}"; \
	echo "Name : ${Name}"; \
	echo "Version : ${Version}"; \
	echo "Release : ${Release}";\
	echo "License : ${License}";\
	echo "Group : ${Group}";\
	echo "Source : ${Source}";\
	echo "BuildRoot : ${BuildRoot}";\
	echo "Requires : ${Requires}";\
	echo "";\
	sed -e "/@POSTINSTALL@/r postinstall" \
	-e "/@POSTINSTALL@/d" \
	-e "/@POSTUNINSTALL@/r postuninstall" \
	-e "/@POSTUNINSTALL@/d" spec) > ${specfile}

install: build
	rm -r -f pkg
	install -d pkg
	cd pkg  && install -d `cat ../dirs`
	cd ../..; ${MAKE} PKGBUILDDIR=${BuildRoot} PKGCONFDIR=/dist install

package: ${specfile}
	rpmbuild -bb ${specfile}
	cp ${rpmroot}/RPMS/${arch}/${pkg_file} .

clean:
	rm -f -r pkg *~ ${specfile}
	cd ../..; ${MAKE} clean
